<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dodaj wątek - Level Next</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Orbitron:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    :root { --yellow:#fff200 }
    body{ margin:0; background:#0b0014; color:var(--yellow); font-family:'Press Start 2P', monospace }
    header{ border-bottom:1px solid var(--yellow); padding:12px 16px; display:flex; gap:12px; align-items:center; justify-content:space-between }
    .btn{ border:1px solid var(--yellow); background:transparent; color:var(--yellow); padding:8px 10px; font-size:.65rem; cursor:pointer }
    main{ max-width: 800px; margin:0 auto; padding:16px 12px }
    form{ border:1px solid var(--yellow); background:rgba(0,0,0,.55); padding:12px; display:flex; flex-direction:column; gap:10px }
    input[type="text"], textarea{ width:100%; background:#000; color:var(--yellow); border:1px solid var(--yellow); padding:10px; font-family:'Press Start 2P', monospace; font-size:.7rem }
    input[type="file"]{ color:var(--yellow) }
  </style>
</head>
<body>
  <header>
    <div>LEVEL NEXT — DODAJ WĄTEK</div>
    <div><a class="btn" href="forum.html">← FORUM</a></div>
  </header>
  <main>
    <form id="form">
      <input type="text" id="title" placeholder="Tytuł wątku" required />
      <textarea id="content" rows="6" placeholder="Treść" required></textarea>
      <label>Obrazek (opcjonalnie): <input type="file" id="image" accept="image/*" /></label>
      <button class="btn">OPUBLIKUJ</button>
      <div style="font-size:.6rem">Dodawać mogą tylko zalogowani. Obrazki lecą do bucketu <i>thread-images</i>.</div>
    </form>
  </main>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
    const SUPABASE_URL = window.SUPABASE_URL || 'https://xxfsvqkvoybdyanmqnpg.supabase.co'
    const SUPABASE_KEY = window.SUPABASE_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsImlhdCI6MTcwMDAwMDAwMCwiZXhwIjoyMDY5NDg0OTYwfQ.1vzkild4JfMdvViTTJ3IggU6YwclZYbCcmuZ28JtF88'
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY)

    async function ensurePublicURL(bucket, path){
      const { data } = supabase.storage.from(bucket).getPublicUrl(path)
      return data?.publicUrl
    }

    document.getElementById('form').addEventListener('submit', async (e)=>{
      e.preventDefault()
      const { data: s } = await supabase.auth.getSession()
      const user = s?.session?.user
      if(!user){ alert('Zaloguj się, aby dodać wątek.'); return }

      const title = (document.getElementById('title').value||'').trim()
      const content = (document.getElementById('content').value||'').trim()
      if(!title || !content) return

      let image_url = null
      const file = document.getElementById('image').files[0]
      if(file){
        const ext = file.name.split('.').pop()
        const path = `${user.id}/${Date.now()}.${ext}`
        const { error: upErr } = await supabase.storage.from('thread-images').upload(path, file, { upsert: true })
        if(upErr){ alert('Błąd uploadu: '+upErr.message); return }
        image_url = await ensurePublicURL('thread-images', path)
      }

      // Spróbuj pobrać nick z profilu
      let nick = null
      try{
        const { data: prof } = await supabase.from('profiles').select('display_name').eq('id', user.id).single()
        nick = prof?.display_name || null
      }catch{}

      const { data, error } = await supabase.from('threads').insert([{ title, content, image_url, user_id: user.id, nick }]).select()
      if(error){ alert(error.message); return }
      const id = data?.[0]?.id
      if(id) location.href = `post.html?id=${id}`
    })
  </script>
</body>
</html>
