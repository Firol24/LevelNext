<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const supabaseUrl = 'https://xxfsvqkvoybdyanmqnpg.supabase.co'
const supabaseKey = 'YOUR_ANON_KEY'
const supabase = createClient(supabaseUrl, supabaseKey)
const adminEmail = 'filipiakr245@gmail.com'
let currentUser = null

// monitorujemy stan sesji
supabase.auth.onAuthStateChange((_, session) => {
  if (session && session.user) {
    currentUser = session.user
    showForum()
  } else {
    currentUser = null
    showAuth()
  }
})

// sprawdź, czy już jesteś zalogowany
;(async () => {
  const { data: { session } } = await supabase.auth.getSession()
  if (session?.user) {
    currentUser = session.user
    showForum()
  } else {
    showAuth()
  }
})()

function showAuth() {
  document.getElementById('auth').style.display = 'flex'
  document.getElementById('forum').style.display = 'none'
}
function showForum() {
  document.getElementById('auth').style.display = 'none'
  document.getElementById('forum').style.display = 'flex'
  document.getElementById('user-info').textContent = `Witaj, ${currentUser.email}`
  fetchThreads()
}

// udostępniamy globalnie
window.signUp = async function() {
  const email = document.getElementById('email-input').value
  const password = document.getElementById('password-input').value
  const { error } = await supabase.auth.signUp({ email, password })
  if (error) alert('Błąd rejestracji: ' + error.message)
  else alert('Sprawdź swój email i potwierdź konto!')
}

window.signIn = async function() {
  const email = document.getElementById('email-input').value
  const password = document.getElementById('password-input').value
  const { error } = await supabase.auth.signInWithPassword({ email, password })
  if (error) alert('Błąd logowania: ' + error.message)
}

window.signOut = async function() {
  await supabase.auth.signOut()
}

// forum
window.fetchThreads = async function() {
  const { data, error } = await supabase
    .from('threads')
    .select('*')
    .order('created_at', { ascending: false })
  if (error) return console.error('Błąd fetch:', error)
  const container = document.getElementById('threads')
  container.innerHTML = ''
  data.forEach(thread => {
    const div = document.createElement('div')
    div.className = 'thread'
    let html = `
      <h3>${thread.title}</h3>
      <p>${thread.content}</p>
      <p style="font-size:0.8em;"><i>${thread.user_id}</i> • ${new Date(thread.created_at).toLocaleString()}</p>
      <div class="thread-actions">`
    if (thread.user_id === currentUser.id || currentUser.email === adminEmail) {
      html += `<button onclick="deleteThread(${thread.id})">Usun</button>`
    }
    if (thread.user_id === currentUser.id) {
      html += `<button onclick="editThread(${thread.id})">Edytuj</button>`
    }
    html += `</div>`
    div.innerHTML = html
    container.appendChild(div)
  })
}

window.addThread = async function() {
  if (!currentUser) return alert('Musisz być zalogowany!')
  const title = document.getElementById('title-input').value.trim()
  const content = document.getElementById('content-input').value.trim()
  if (!title || !content) return alert('Uzupełnij wszystkie pola!')
  const { error } = await supabase
    .from('threads')
    .insert([{ title, content, user_id: currentUser.id }])
  if (error) alert('Błąd przy dodawaniu wątku: ' + error.message)
  else {
    document.getElementById('title-input').value = ''
    document.getElementById('content-input').value = ''
    fetchThreads()
  }
}

window.deleteThread = async function(id) {
  if (!confirm('Na pewno usunąć wątek?')) return
  const { error } = await supabase
    .from('threads')
    .delete()
    .eq('id', id)
  if (error) alert('Błąd przy usuwaniu: ' + error.message)
  else fetchThreads()
}

window.editThread = async function(id) {
  const { data, error } = await supabase
    .from('threads')
    .select('title, content')
    .eq('id', id)
    .single()
  if (error) return alert('Błąd przy pobieraniu danych: ' + error.message)
  const newTitle = prompt('Nowy tytuł wątku:', data.title)
  if (newTitle === null) return
  const newContent = prompt('Nowa treść wątku:', data.content)
  if (newContent === null) return
  const { error: updateError } = await supabase
    .from('threads')
    .update({ title: newTitle, content: newContent })
    .eq('id', id)
  if (updateError) alert('Błąd przy edycji: ' + updateError.message)
  else fetchThreads()
}
</script>
